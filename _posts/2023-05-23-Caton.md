---
layout:     post
title:      "Android 线上监控方案"
subtitle:   "线上发生 卡顿/ANR/Crash 了怎么办"
date:       2023-05-23
author:     "Hurshi"
catalog: true
tags:
    - ANR
    - 卡顿
    - Crash
    - 监控
---

# 前置知识

### Linux 知识

>  fork 进程

1.  fork 主进程后，子进程与主进程共享内存空间
2.  子进程中不会有主进程中的线程信息；

>  抓取堆栈

1.  抓当前线程的堆栈，可以直接抓；
2.  抓其他线程的堆栈，需要将目标线程挂起，抓完后再恢复；

>  hprof

# 监控
### 监控卡顿
1. BlockCanary 方案

   > 主线程所有执行的任务都在 `dispatchMessage` 方法中派发执行；可以通过`setMessageLogging()`的方式，统计`dispatchMessage`执行前后的时间差，来判断是否有卡顿；

2. Choreographer 方案

   > 推荐阅读：[Choreographer原理](http://gityuan.com/2017/02/25/choreographer/)，[SurfaceFlinger 绘图](http://gityuan.com/2017/02/18/surface_flinger_2/)

   ```java
   Choreographer.getInstance().postFrameCallback(new Choreographer.FrameCallback() {
       @Override
       public void doFrame(long frameTimeNanos) {
           
       }
   });
   ```

   > 注册

3. Matrix 方案

### 监控 ANR

1. 监听 UI 线程 Handler
1. Matrix 方案




### 监控 Crash

1. Java Crash

   ```java
   Thread.setDefaultUncaughtExceptionHandler(new Thread.UncaughtExceptionHandler() {
       @Override
       public void uncaughtException(Thread t, Throwable e) {
           
       }
   });
   ```

2. Native Crash

# 采集
### 采集堆栈

>  采样型

*  原理：定时去获取指定线程的堆栈信息
*  方案：
   1.  Debug.startMethodTracingSampling
   2.  Profilo 
   2.  Sliver

>  埋点型

*  原理：在函数执行的出入口记录时间和方法名
*  方案：
   1.  Systrace
   2.  Debug.startMethodTracing
   3.  Nanoscope
   4.  字节码插桩

### 采集内存

fork 主进程，在子进程采集 hprof 数据

# 三方方案介绍

### Sliver







# 参考

1.  [西瓜视频稳定性治理体系建设三：Sliver 原理及实践](https://blog.csdn.net/ByteDanceTech/article/details/119621240)
1.  [干货|安卓APP崩溃捕获方案——xCrash](https://mp.weixin.qq.com/s?__biz=MzI0MjczMjM2NA==&mid=2247485203&idx=1&sn=26fd99ca1201e292ea5531c814eeb881t)
1.  [字节跳动技术团队 # ANR](https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&album_id=1780091311874686979)
1.  [Android 性能优化必知必会](https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools)