---
layout:     post
title:      "Android 线上监控方案"
subtitle:   "线上发生卡顿/ANR/Crash 了怎么办"
date:       2023-05-23
author:     "Hurshi"
catalog: true
tags:
    - ANR
    - 卡顿
    - Crash
    - 监控
---

# 前置知识

### Linux 知识

>  fork 进程

1.  fork 主进程后，子进程与主进程共享内存空间
2.  子进程中不会有主进程中的线程信息；

>  抓取堆栈

1.  抓当前线程的堆栈，可以直接抓；
2.  抓其他线程的堆栈，需要将目标线程挂起，抓完后再恢复；

>  hprof

# 监控卡顿

### BlockCanary

通过处理 `dispatchMessage`的时间是否超过阈值

### Choreographer

注册 doFrame() 回调

### Matrix





# 监控 ANR

### 方案



### 微信 Matrix

1.  



# 监控 Crash

### 监控 Java Crash：

`uncaughtException`

### 监控 Native Crash：

订阅信号量

# 采集堆栈

>  采样型

*  原理：定时去获取指定线程的堆栈信息
*  方案：
   1.  Debug.startMethodTracingSampling
   2.  Profilo 
   2.  Sliver

>  埋点型

*  原理：在函数执行的出入口记录时间和方法名
*  方案：
   1.  Systrace
   2.  Debug.startMethodTracing
   3.  Nanoscope
   4.  字节码插桩

# 采集 hprof

fork 主进程，在子进程采集数据

# 三方方案介绍

### Sliver







# 参考

1.  [西瓜视频稳定性治理体系建设三：Sliver 原理及实践](https://blog.csdn.net/ByteDanceTech/article/details/119621240)
1.  [干货|安卓APP崩溃捕获方案——xCrash](https://mp.weixin.qq.com/s?__biz=MzI0MjczMjM2NA==&mid=2247485203&idx=1&sn=26fd99ca1201e292ea5531c814eeb881t)
1.  [字节跳动技术团队 # ANR](https://mp.weixin.qq.com/mp/appmsgalbum?action=getalbum&album_id=1780091311874686979)
1.  [Android 性能优化必知必会](https://androidperformance.com/2018/05/07/Android-performance-optimization-skills-and-tools)