I"²<p>åœ¨ç†è§£Handlerè·¨çº¿ç¨‹ä¹‹å‰ï¼Œéœ€è¦å…ˆç†è§£ä¸‹é¢å‡ ä¸ªæ¦‚å¿µï¼šThreadLocal , MessageQueue , Looper</p>

<h5 id="threadlocal">ThreadLocal</h5>

<ul>
  <li>
    <p>ä¸€èˆ¬æ¥è¯´ï¼Œå˜é‡å¯ä»¥è¢«ä¸åŒçº¿ç¨‹è¯»å†™ï¼Œä½†æ˜¯ThreadLocalåªæœ‰å½“å‰çº¿ç¨‹å¯ä»¥è¯»å†™ï¼Œå°±åƒå¤šè¿›ç¨‹ä¸€æ ·ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´è®¿é—®åŒä¸€ä¸ªThreadLocalå˜é‡æ˜¯å®Œå…¨ç‹¬ç«‹äº’ä¸å¹²æ‰°çš„ï¼›</p>
  </li>
  <li>æºç 
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre></td><td class="rouge-code"><pre>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Thread</span> <span class="kd">implements</span> <span class="nc">Runnable</span> <span class="o">{</span>
      <span class="o">...</span>
      <span class="nc">ThreadLocal</span><span class="o">.</span><span class="na">ThreadLocalMap</span> <span class="n">threadLocals</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
      <span class="o">...</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="no">T</span><span class="o">&gt;</span> <span class="o">{</span>
      <span class="kd">public</span> <span class="kt">void</span> <span class="nf">set</span><span class="o">(</span><span class="no">T</span> <span class="n">value</span><span class="o">)</span> <span class="o">{</span>
          <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
          <span class="nc">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
              <span class="n">map</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">this</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
          <span class="k">else</span>
              <span class="nf">createMap</span><span class="o">(</span><span class="n">t</span><span class="o">,</span> <span class="n">value</span><span class="o">);</span>
      <span class="o">}</span>

      <span class="kd">public</span> <span class="no">T</span> <span class="nf">get</span><span class="o">()</span> <span class="o">{</span>
          <span class="nc">Thread</span> <span class="n">t</span> <span class="o">=</span> <span class="nc">Thread</span><span class="o">.</span><span class="na">currentThread</span><span class="o">();</span>
          <span class="nc">ThreadLocalMap</span> <span class="n">map</span> <span class="o">=</span> <span class="n">getMap</span><span class="o">(</span><span class="n">t</span><span class="o">);</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">map</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="nc">ThreadLocalMap</span><span class="o">.</span><span class="na">Entry</span> <span class="n">e</span> <span class="o">=</span> <span class="n">map</span><span class="o">.</span><span class="na">getEntry</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">e</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span>
                  <span class="k">return</span> <span class="o">(</span><span class="no">T</span><span class="o">)</span> <span class="n">e</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
          <span class="o">}</span>
          <span class="k">return</span> <span class="nf">setInitialValue</span><span class="o">();</span>
      <span class="o">}</span>

      <span class="nc">ThreadLocalMap</span> <span class="nf">getMap</span><span class="o">(</span><span class="nc">Thread</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">return</span> <span class="n">t</span><span class="o">.</span><span class="na">threadLocals</span><span class="o">;</span>
      <span class="o">}</span>
  <span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>ä¸Šè¿°å†…å®¹éå¸¸å®¹æ˜“ç†è§£ï¼Œæ¯æ–°å»ºä¸€ä¸ª Thread å°±ä¼šåœ¨æ–° Thread ä¸­ä¿ç•™ç€ ThreadLocalMap å®ä¾‹ï¼Œè€Œä» ThreadLocal ä¸­ get value åˆ™ä¼šä»å½“å‰çš„Threadä¸­å»è·å– threadLocals å˜é‡ï¼Œä»ä¸­å–å€¼ã€‚ä»¥æ­¤å®ç° ThreadLocal åœ¨å„è‡ªçº¿ç¨‹ä¸­ç‹¬ç«‹ä¿å­˜ value çš„åŠŸèƒ½ï¼›</li>
</ul>

<h5 id="messagequeue">MessageQueue</h5>

<ul>
  <li>æºç ç•¥é•¿ï¼Œä¸»è¦çœ‹çœ‹æœ‰ä¸­æ–‡æ³¨é‡Šçš„åœ°æ–¹
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
</pre></td><td class="rouge-code"><pre>
    <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">MessageQueue</span> <span class="o">{</span>
        <span class="kt">boolean</span> <span class="nf">enqueueMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">long</span> <span class="n">when</span><span class="o">)</span> <span class="o">{</span><span class="c1">//æ’å…¥æ¶ˆæ¯</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span><span class="c1">//handlerå¯¹è±¡</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalArgumentException</span><span class="o">(</span><span class="s">"Message must have a target."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">isInUse</span><span class="o">())</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">IllegalStateException</span><span class="o">(</span><span class="n">msg</span> <span class="o">+</span> <span class="s">" This message is already in use."</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mQuitting</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">IllegalStateException</span> <span class="n">e</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IllegalStateException</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">+</span> <span class="s">" sending message to a Handler on a dead thread"</span><span class="o">);</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">recycle</span><span class="o">();</span>
                    <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="n">msg</span><span class="o">.</span><span class="na">markInUse</span><span class="o">();</span>
                <span class="n">msg</span><span class="o">.</span><span class="na">when</span> <span class="o">=</span> <span class="n">when</span><span class="o">;</span>
                <span class="nc">Message</span> <span class="n">p</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>
                <span class="kt">boolean</span> <span class="n">needWake</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">when</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">when</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="na">when</span><span class="o">)</span> <span class="o">{</span>
                    <span class="c1">// New head, wake up the event queue if blocked.</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                    <span class="n">mMessages</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
                    <span class="n">needWake</span> <span class="o">=</span> <span class="n">mBlocked</span><span class="o">;</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">needWake</span> <span class="o">=</span> <span class="n">mBlocked</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">isAsynchronous</span><span class="o">();</span>
                    <span class="nc">Message</span> <span class="n">prev</span><span class="o">;</span>
                    <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                        <span class="n">prev</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span>
                        <span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">p</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">when</span> <span class="o">&lt;</span> <span class="n">p</span><span class="o">.</span><span class="na">when</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">break</span><span class="o">;</span>
                        <span class="o">}</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">needWake</span> <span class="o">&amp;&amp;</span> <span class="n">p</span><span class="o">.</span><span class="na">isAsynchronous</span><span class="o">())</span> <span class="o">{</span>
                            <span class="n">needWake</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                    <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">p</span><span class="o">;</span> <span class="c1">// invariant: p == prev.next</span>
                    <span class="n">prev</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
                <span class="o">}</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">needWake</span><span class="o">)</span> <span class="o">{</span>
                    <span class="n">nativeWake</span><span class="o">(</span><span class="n">mPtr</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="k">return</span> <span class="kc">true</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nc">Message</span> <span class="nf">next</span><span class="o">()</span> <span class="o">{</span><span class="c1">//å–å‡ºæ¶ˆæ¯</span>
            <span class="kd">final</span> <span class="kt">long</span> <span class="n">ptr</span> <span class="o">=</span> <span class="n">mPtr</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="kt">int</span> <span class="n">pendingIdleHandlerCount</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span> <span class="c1">// -1 only during first iteration</span>
            <span class="kt">int</span> <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">nextPollTimeoutMillis</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                    <span class="nc">Binder</span><span class="o">.</span><span class="na">flushPendingCommands</span><span class="o">();</span>
                <span class="o">}</span>
                <span class="n">nativePollOnce</span><span class="o">(</span><span class="n">ptr</span><span class="o">,</span> <span class="n">nextPollTimeoutMillis</span><span class="o">);</span>
                <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">();</span>
                    <span class="nc">Message</span> <span class="n">prevMsg</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">mMessages</span><span class="o">;</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">do</span> <span class="o">{</span>
                            <span class="n">prevMsg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">;</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">while</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">msg</span><span class="o">.</span><span class="na">isAsynchronous</span><span class="o">());</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">now</span> <span class="o">&lt;</span> <span class="n">msg</span><span class="o">.</span><span class="na">when</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="nc">Math</span><span class="o">.</span><span class="na">min</span><span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">when</span> <span class="o">-</span> <span class="n">now</span><span class="o">,</span> <span class="nc">Integer</span><span class="o">.</span><span class="na">MAX_VALUE</span><span class="o">);</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="n">mBlocked</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                            <span class="k">if</span> <span class="o">(</span><span class="n">prevMsg</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                                <span class="n">prevMsg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                                <span class="n">mMessages</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="na">next</span><span class="o">;</span>
                            <span class="o">}</span>
                            <span class="n">msg</span><span class="o">.</span><span class="na">next</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                            <span class="n">msg</span><span class="o">.</span><span class="na">markInUse</span><span class="o">();</span>
                            <span class="k">return</span> <span class="n">msg</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">mQuitting</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">dispose</span><span class="o">();</span>
                        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pendingIdleHandlerCount</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">(</span><span class="n">mMessages</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">||</span> <span class="n">now</span> <span class="o">&lt;</span> <span class="n">mMessages</span><span class="o">.</span><span class="na">when</span><span class="o">))</span> <span class="o">{</span>
                        <span class="n">pendingIdleHandlerCount</span> <span class="o">=</span> <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">size</span><span class="o">();</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">pendingIdleHandlerCount</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mBlocked</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
                        <span class="k">continue</span><span class="o">;</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">mPendingIdleHandlers</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                        <span class="n">mPendingIdleHandlers</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">IdleHandler</span><span class="o">[</span><span class="nc">Math</span><span class="o">.</span><span class="na">max</span><span class="o">(</span><span class="n">pendingIdleHandlerCount</span><span class="o">,</span> <span class="mi">4</span><span class="o">)];</span>
                    <span class="o">}</span>
                    <span class="n">mPendingIdleHandlers</span> <span class="o">=</span> <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">toArray</span><span class="o">(</span><span class="n">mPendingIdleHandlers</span><span class="o">);</span>
                <span class="o">}</span>
                <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pendingIdleHandlerCount</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kd">final</span> <span class="nc">IdleHandler</span> <span class="n">idler</span> <span class="o">=</span> <span class="n">mPendingIdleHandlers</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                    <span class="n">mPendingIdleHandlers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span> <span class="c1">// release the reference to the handler</span>
                    <span class="kt">boolean</span> <span class="n">keep</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">keep</span> <span class="o">=</span> <span class="n">idler</span><span class="o">.</span><span class="na">queueIdle</span><span class="o">();</span>
                    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Throwable</span> <span class="n">t</span><span class="o">)</span> <span class="o">{</span>
                        <span class="nc">Log</span><span class="o">.</span><span class="na">wtf</span><span class="o">(</span><span class="no">TAG</span><span class="o">,</span> <span class="s">"IdleHandler threw exception"</span><span class="o">,</span> <span class="n">t</span><span class="o">);</span>
                    <span class="o">}</span>
                    <span class="k">if</span> <span class="o">(!</span><span class="n">keep</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kd">synchronized</span> <span class="o">(</span><span class="k">this</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">mIdleHandlers</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">idler</span><span class="o">);</span>
                        <span class="o">}</span>
                    <span class="o">}</span>
                <span class="o">}</span>
                <span class="n">pendingIdleHandlerCount</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
                <span class="n">nextPollTimeoutMillis</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>åˆ†æ</p>

    <ol>
      <li>ä»¥ä¸Šä»£ç ç•¥æ˜¾å¤æ‚ï¼Œä½†æ˜¯æœ€å…³é”®å°±æ˜¯ enqueueMessage æ–¹æ³•å’Œ next æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯æ’å…¥æ•°æ®ï¼Œå¦ä¸€ä¸ªæ˜¯å–å‡ºæ•°æ®ï¼Œæ•°æ®ä¿å­˜åœ¨å˜é‡ mMessages ä¸Šï¼›</li>
      <li>ä¸ç”¨æ·±ç©¶ä»£ç ï¼ŒæŸ¥çœ‹å…³é”®ä¿¡æ¯ä¸éš¾å‘ç°ï¼šè¿™é‡Œæ˜¯è·¨çº¿ç¨‹çš„å…³é”®ç‚¹ï¼Œå±€éƒ¨å˜é‡ mMessages å¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹è®¿é—®ï¼Œnextè¿è¡Œåœ¨å½“å‰çº¿ç¨‹ï¼ŒenqueueMessage æ–¹æ³•å¯ä»¥åœ¨æ–°çº¿ç¨‹ä¸­è®¿é—®ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ–°çº¿ç¨‹ä¸­è°ƒç”¨enqueueMessageæ–¹æ³•æ’å…¥æ¶ˆæ¯ï¼Œnextåˆ™ä¼šåœ¨å½“å‰çº¿ç¨‹ä¸æ–­è½®è¯¢æ˜¯å¦æœ‰æ–°æ¶ˆæ¯åŠ å…¥ï¼Œè‹¥åŠ å…¥åˆ™è¿”å›Messageå¯¹è±¡ï¼Œåœ¨å½“å‰çº¿ç¨‹æ¥æ”¶æ¶ˆæ¯ï¼›</li>
    </ol>
  </li>
</ul>

<h5 id="looper">Looper</h5>

<ul>
  <li>å¼€å‘ä¸­æ—¶å¸¸é‡åˆ°è¿™æ ·çš„ bugï¼Œå¯¹ä»˜è¿™æ ·çš„é—®é¢˜ï¼Œçœ‹çœ‹ä¸‹é¢çš„æºç å°±èƒ½æ°´è½çŸ³å‡ºã€‚
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre></td><td class="rouge-code"><pre>  <span class="n">java</span><span class="o">.</span><span class="na">lang</span><span class="o">.</span><span class="na">RuntimeException</span><span class="o">:</span> <span class="nc">Can</span><span class="err">'</span><span class="n">t</span> <span class="n">create</span> <span class="n">handler</span> <span class="n">inside</span> <span class="n">thread</span> <span class="n">that</span> <span class="n">has</span> <span class="n">not</span> <span class="n">called</span> <span class="nc">Looper</span><span class="o">.</span><span class="na">prepare</span><span class="o">()</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>æºç çœ‹çœ‹ï¼š
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre>  <span class="kd">public</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">Looper</span> <span class="o">{</span>
  <span class="c1">//æ˜¾ç„¶ï¼Œåœ¨ä¸åŒçº¿ç¨‹ä¼šå­˜æœ‰äº’ä¸å¹²æ‰°çš„Looperå®ä¾‹</span>
  <span class="kd">static</span> <span class="kd">final</span> <span class="nc">ThreadLocal</span><span class="o">&lt;</span><span class="nc">Looper</span><span class="o">&gt;</span> <span class="n">sThreadLocal</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">ThreadLocal</span><span class="o">&lt;&gt;();</span>

  <span class="kd">private</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">prepare</span><span class="o">(</span><span class="kt">boolean</span> <span class="n">quitAllowed</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">sThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">()</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"Only one Looper may be created per thread"</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="n">sThreadLocal</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="k">new</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Looper</span><span class="o">(</span><span class="n">quitAllowed</span><span class="o">));</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">loop</span><span class="o">()</span> <span class="o">{</span>
      <span class="kd">final</span> <span class="n">android</span><span class="o">.</span><span class="na">os</span><span class="o">.</span><span class="na">Looper</span> <span class="n">me</span> <span class="o">=</span> <span class="n">myLooper</span><span class="o">();</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">me</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">RuntimeException</span><span class="o">(</span><span class="s">"No Looper; Looper.prepare() wasn't called on this thread."</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="kd">final</span> <span class="nc">MessageQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="na">mQueue</span><span class="o">;</span>

      <span class="k">for</span> <span class="o">(;</span> <span class="o">;</span> <span class="o">)</span> <span class="o">{</span>
          <span class="nc">Message</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="na">next</span><span class="o">();</span> <span class="c1">// è‹¥æ²¡æœ‰æ¶ˆæ¯åˆ™é˜»å¡åœ¨è¿™é‡Œ</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">msg</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
              <span class="k">return</span><span class="o">;</span>
          <span class="o">}</span>

          <span class="kd">final</span> <span class="kt">long</span> <span class="n">traceTag</span> <span class="o">=</span> <span class="n">me</span><span class="o">.</span><span class="na">mTraceTag</span><span class="o">;</span>
          <span class="k">if</span> <span class="o">(</span><span class="n">traceTag</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="nc">Trace</span><span class="o">.</span><span class="na">isTagEnabled</span><span class="o">(</span><span class="n">traceTag</span><span class="o">))</span> <span class="o">{</span>
              <span class="nc">Trace</span><span class="o">.</span><span class="na">traceBegin</span><span class="o">(</span><span class="n">traceTag</span><span class="o">,</span> <span class="n">msg</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">getTraceName</span><span class="o">(</span><span class="n">msg</span><span class="o">));</span>
          <span class="o">}</span>
          <span class="k">try</span> <span class="o">{</span>
              <span class="n">msg</span><span class="o">.</span><span class="na">target</span><span class="o">.</span><span class="na">dispatchMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span><span class="c1">//åˆ†å‘æ¶ˆæ¯</span>
          <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
              <span class="k">if</span> <span class="o">(</span><span class="n">traceTag</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                  <span class="nc">Trace</span><span class="o">.</span><span class="na">traceEnd</span><span class="o">(</span><span class="n">traceTag</span><span class="o">);</span>
              <span class="o">}</span>
          <span class="o">}</span>
          <span class="n">msg</span><span class="o">.</span><span class="na">recycleUnchecked</span><span class="o">();</span>
      <span class="o">}</span>
  <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">static</span> <span class="nd">@Nullable</span> <span class="nc">Looper</span> <span class="nf">myLooper</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="n">sThreadLocal</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>
    <p>åˆ†æ</p>

    <ol>
      <li>
        <p>å…ˆè®²2ä¸ªæ•…äº‹ï¼š</p>

        <blockquote>
          <p><strong>æ•…äº‹1ï¼š</strong>å°æ˜æ²¡æœ‰é›¶èŠ±é’±äº†ï¼Œåˆä¸æ•¢å‘çˆ¸çˆ¸å¦ˆå¦ˆï¼Œå°±æƒ³èµ·äº†ä»–å¥¶å¥¶ã€‚ä»–å¥¶å¥¶å®¶å’Œä»–å®¶è·ç¦»ä¸è¿œä¹Ÿå°±å‡ ç™¾ç±³ï¼Œäºæ˜¯ä»–å°±åˆ°ä»–å¥¶å¥¶å®¶å»äº†ï¼Œä½†æ˜¯å°æ˜å¥¶å¥¶å®¶é‡Œæ²¡æœ‰ç°é‡‘äº†ï¼Œè€Œå¥¶å¥¶åˆå¹´çºªå¤§äº†ä¸æ–¹ä¾¿å»å–é’±ï¼Œå°±æ‰“ç”µè¯ç»™é“¶è¡Œè¦æ±‚é“¶è¡Œé€é’±ä¸Šé—¨ï¼Œä½†æ˜¯é“¶è¡Œå·¥ä½œäººå‘˜åŠäº‹æ•ˆç‡ä¸é«˜ï¼ŒåŠå¤©éƒ½æ²¡æœ‰é€æ¥ï¼Œäºæ˜¯ç€æ€¥çš„å°æ˜åªèƒ½ç©ºæ‰‹è€Œè¿”äº†ï¼›è¿‡äº†ä¸€ä¼šä»–åˆå»å¥¶å¥¶å®¶çœ‹é’±æœ‰æ²¡æœ‰é€è¿‡æ¥ï¼Œç»“æœé“¶è¡Œå·¥ä½œäººå‘˜è¿˜æ²¡æœ‰è¿‡æ¥ï¼Œå°æ˜åªèƒ½å†æ¬¡ç©ºæ‰‹è€Œè¿”â€¦â€¦å°±è¿™æ ·ä¸æ–­æ¥æ¥å›å›å»å¥¶å¥¶å®¶çœ‹é’±æœ‰æ²¡æœ‰é€è¿‡æ¥ï¼›
<strong>æ•…äº‹2ï¼š</strong>å°çº¢å’Œå°æ˜ä¸€æ ·æ²¡æœ‰é›¶èŠ±é’±å´åˆä¸æ•¢å‘çˆ¸çˆ¸å¦ˆå¦ˆè¦ï¼Œä¹Ÿå»æ‰¾å¥¶å¥¶è¦ï¼›å°çº¢ç¬¬ä¸€æ¬¡å»å¥¶å¥¶å®¶ï¼Œå¥¶å¥¶å‘ç°å®¶é‡Œæ²¡æœ‰ç°é‡‘äº†ï¼Œå°±æ‰“ç”µè¯ç»™é“¶è¡Œè¦æ±‚é€é’±ä¸Šé—¨ï¼Œè€Œå°çº¢åˆ™é™ªç€å¥¶å¥¶åœ¨å®¶é‡Œç­‰é“¶è¡Œå·¥ä½œäººå‘˜é€å‰ä¸Šé—¨ï¼Œå¥¶å¥¶å¿ƒç–¼å°çº¢ï¼Œä¸æ–­æ‰“ç”µè¯å‚¬é“¶è¡Œå¿«ç‚¹å¿«ç‚¹ï¼›å°±è¿™æ ·å°çº¢æ¯æ¬¡å»å¥¶å¥¶å®¶è¦é›¶èŠ±é’±éƒ½æ˜¯ç­‰æ‹¿åˆ°é’±äº†å†ç¦»å¼€ï¼›</p>
        </blockquote>
      </li>
      <li>
        <p>æš‚ä¸”ä¸ç®¡ä¸Šè¿°æ•…äº‹å‰§æƒ…å¦‚ä½•ï¼Œå…¶ä¸­å°æ˜æ˜¯ä¸ç®¡å¥¶å¥¶åœ¨ä¸åœ¨å®¶ï¼Œå»äº†å°±å›æ¥ï¼Œæœ‰é’±å°±æ‹¿é’±ï¼Œæ²¡é’±å°±ç©ºæ‰‹å›å®¶ï¼Œè€Œå°çº¢æ˜¯å»äº†å°±æ‹¿åˆ°é’±æ‰å›æ¥ï¼›å›åˆ°Looperä¸Šæ¥ï¼Œ<code class="highlighter-rouge">loop</code>æ–¹æ³•å°±åƒæ˜¯å°çº¢ï¼Œè€Œå¥¶å¥¶åˆ™æ˜¯<code class="highlighter-rouge">MessageQueue</code>ï¼Œ<code class="highlighter-rouge">loop</code>æ–¹æ³•è°ƒç”¨<code class="highlighter-rouge">MessageQueue</code>çš„<code class="highlighter-rouge">next</code>æ–¹æ³•ï¼Œè‹¥<code class="highlighter-rouge">next</code>æ–¹æ³•æ²¡æœ‰ä¸œè¥¿å¯è¿”å›å°±ä¸€ç›´ç­‰ç€ï¼Œå¹¶ä¸”ä¸æ–­è¯¢é—®æœ‰æ²¡æœ‰æ–°æ¶ˆæ¯è¿‡æ¥ï¼›</p>
      </li>
      <li>
        <p>è¦åœ¨æ–°çº¿ç¨‹ä¸­ä½¿ç”¨<code class="highlighter-rouge">Looper</code>,éœ€è¦åˆå§‹åŒ–<code class="highlighter-rouge">Looper</code>ï¼Œå› ä¸º<code class="highlighter-rouge">Looper</code>å¯¹è±¡æ˜¯ä¿å­˜åœ¨<code class="highlighter-rouge">ThreadLocal</code>ä¸Šçš„ï¼Œæ‰€ä»¥åœ¨æ¯ä¸ªçº¿ç¨‹ä¸Šéƒ½éœ€è¦é‡æ–°åˆå§‹åŒ–ï¼Œå¹¶ä¸”ä¸èƒ½é‡å¤åˆå§‹åŒ–ï¼›</p>
      </li>
      <li>
        <p>å¼€å¯æ¶ˆæ¯å¾ªç¯éœ€è¦è°ƒç”¨<code class="highlighter-rouge">Looper.loop();</code>,ç»“æŸæ—¶å€™åˆ«å¿˜äº†è¦<code class="highlighter-rouge">Looper.myLooper().quit();</code>é€€å‡ºè½®è¯¢ï¼›</p>
      </li>
    </ol>
  </li>
</ul>

<h3 id="handler">Handler</h3>

<ul>
  <li>
    <p>çœ‹å®Œäº†ä»¥ä¸Šçš„ ThreadLocal , MessageQueue , Looperï¼Œå†çœ‹ Handler å°±æ°´åˆ°æ¸ æˆäº†ï¼š</p>

    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre></td><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Handler</span> <span class="o">{</span>
    <span class="kd">final</span> <span class="nc">MessageQueue</span> <span class="n">mQueue</span><span class="o">;</span>
  
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">sendMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">sendMessageDelayed</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="mi">0</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">sendMessageDelayed</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">long</span> <span class="n">delayMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">delayMillis</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">delayMillis</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">sendMessageAtTime</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="nc">SystemClock</span><span class="o">.</span><span class="na">uptimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">delayMillis</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">sendMessageAtTime</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">long</span> <span class="n">uptimeMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">MessageQueue</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">mQueue</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">queue</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">false</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="nf">enqueueMessage</span><span class="o">(</span><span class="n">queue</span><span class="o">,</span> <span class="n">msg</span><span class="o">,</span> <span class="n">uptimeMillis</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="kd">private</span> <span class="kt">boolean</span> <span class="nf">enqueueMessage</span><span class="o">(</span><span class="nc">MessageQueue</span> <span class="n">queue</span><span class="o">,</span> <span class="nc">Message</span> <span class="n">msg</span><span class="o">,</span> <span class="kt">long</span> <span class="n">uptimeMillis</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">msg</span><span class="o">.</span><span class="na">target</span> <span class="o">=</span> <span class="k">this</span><span class="o">;</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">mAsynchronous</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">msg</span><span class="o">.</span><span class="na">setAsynchronous</span><span class="o">(</span><span class="kc">true</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">queue</span><span class="o">.</span><span class="na">enqueueMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">,</span> <span class="n">uptimeMillis</span><span class="o">);</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">dispatchMessage</span><span class="o">(</span><span class="nc">Message</span> <span class="n">msg</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">msg</span><span class="o">.</span><span class="na">callback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">handleCallback</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">mCallback</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">mCallback</span><span class="o">.</span><span class="na">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">))</span> <span class="o">{</span>
                    <span class="k">return</span><span class="o">;</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="n">handleMessage</span><span class="o">(</span><span class="n">msg</span><span class="o">);</span><span class="c1">//å›è°ƒåˆ°ç†Ÿæ‚‰çš„æ–¹æ³•å•¦</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div>    </div>
  </li>
  <li>åˆ†æHandleræ˜¯å¦‚ä½•çº¿ç¨‹é—´ä¼ é€’çš„ï¼š
    <ol>
      <li>ç”±ç†Ÿæ‚‰çš„<code class="highlighter-rouge">sendMessage</code>å¼€å§‹ï¼Œæœ€åéƒ½æ˜¯è°ƒç”¨<code class="highlighter-rouge">enqueueMessage</code>æ–¹æ³•ï¼Œè€Œæœ€ç»ˆè¿˜æ˜¯è°ƒç”¨<code class="highlighter-rouge">MessageQueue</code>ç±»çš„<code class="highlighter-rouge">enqueueMessage</code>æ–¹æ³•,åˆ°æ­¤ä¸ºæ­¢æˆ‘ä»¬ä¸€èˆ¬éƒ½æ˜¯åœ¨æ–°çº¿ç¨‹è°ƒç”¨ï¼›</li>
      <li>æ¥ä¸‹æ¥<code class="highlighter-rouge">Looper</code>ç±»çš„<code class="highlighter-rouge">loop</code>æ–¹æ³•ä¼šåœ¨å½“å‰çº¿ç¨‹ï¼ˆå¦‚æœæ˜¯æ›´æ–°UIåˆ™åœ¨ä¸»çº¿ç¨‹ï¼‰ä»<code class="highlighter-rouge">MessageQueue</code>ä¸­è·å–æœ€æ–°æ¶ˆæ¯ï¼Œé€šè¿‡<code class="highlighter-rouge">msg.target.dispatchMessage(msg);</code>è°ƒç”¨åˆ°<code class="highlighter-rouge">Handler</code>ä¸­æ¥ï¼ˆä¸Šè¿°ä»£ç ï¼‰ï¼Œç„¶åè°ƒç”¨åˆ°<code class="highlighter-rouge">handlemessage(msg)</code>æˆ‘ä»¬å°±ç†Ÿæ‚‰å•¦ï¼›</li>
      <li>ç”±æ­¤ï¼ŒHandlerè·¨çº¿ç¨‹æœ€é‡è¦çš„æ˜¯åœ¨å½“å‰çº¿ç¨‹ï¼ˆåˆå§‹åŒ–<code class="highlighter-rouge">Handler</code>çš„çº¿ç¨‹ï¼‰è¿›è¡Œ<code class="highlighter-rouge">loop</code>è½®è¯¢ï¼Œè€Œå˜é‡æ˜¯å¯ä»¥åœ¨ä¸åŒçº¿ç¨‹è®¿é—®Â·çš„ï¼Œæ‰€ä»¥<code class="highlighter-rouge">Handler</code>å¯ä»¥åœ¨å…¶ä»–çº¿ç¨‹å‘<code class="highlighter-rouge">MessageQueue</code>ä¸­æ’å…¥æ•°æ®ï¼Œè€Œ<code class="highlighter-rouge">loop</code>åˆ™åœ¨å½“å‰çº¿ç¨‹ä¸æ–­å»å–æ•°æ®ï¼Œå–å¾—æ•°æ®å°±å›è°ƒï¼Œè¾¾åˆ°è·¨çº¿ç¨‹çš„ç›®çš„ï¼›</li>
    </ol>
  </li>
  <li>é‚£ä¹ˆä¸ºä»€ä¹ˆ Handler å®¹æ˜“å¯¼è‡´<strong>å†…å­˜æ³„æ¼</strong>å‘¢ï¼Ÿ
    <ol>
      <li>é¦–å…ˆï¼Œå†…éƒ¨ç±»æˆ–è€…æˆå‘˜å˜é‡éƒ½ä¼šæŒæœ‰å¤–éƒ¨å®ä¾‹å¯¹è±¡çš„å¼•ç”¨</li>
      <li>Handler åœ¨å‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œä¼šå°†è‡ªå·±(Handlerå®ä¾‹)ä¹Ÿå‘é€è¿‡å»ï¼Œè§å¦‚ä¸Šä»£ç  <code class="highlighter-rouge">enqueueMessage</code>æ–¹æ³•ç¬¬ä¸€è¡Œï¼š<code class="highlighter-rouge">msg.target = this;</code></li>
      <li>è€Œè¿™æ¡ Message ä¼šä¿å­˜åœ¨ MessageQueue#mMessages ä¸­,æœ€ç»ˆä¼šä¿å­˜åœ¨ThreadLocalä¸­ï¼Œæ„å‘³ç€å¦‚æœæ²¡æœ‰å°†è¯¥æ¡ Message åŠæ—¶æ¶ˆåŒ–æ‰çš„è¯ï¼Œå®ƒä¼šæ°¸è¿œå­˜åœ¨äºä¸»çº¿ç¨‹ä¸­ï¼›æ„å‘³ç€å’Œä¸»çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸä¿æŒä¸€è‡´çš„ä¸€ä¸ªå®åŠ›å¯¹è±¡ ThreadLocal ä¸­ä¿å­˜äº†ä¸€ä¸ª Activity å¯¹è±¡ï¼Œè€Œä¸»çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç»å¯¹è¦æ¯” Activity é•¿ï¼Œæ‰€ä»¥å¯¼è‡´è¯¥ Activity å†…å­˜æ³„æ¼äº†ã€‚</li>
      <li>æ‰€ä»¥ï¼Œå¦‚æœèƒ½ä¿è¯åœ¨ Activity é”€æ¯ä¹‹å‰èƒ½å°†å‘å‡ºçš„ Message å…¨éƒ¨æ¶ˆåŒ–æ‰ï¼Œé‚£ä¹Ÿæ²¡äº‹ã€‚</li>
    </ol>
  </li>
</ul>

<h3 id="message-å¤ç”¨">Message å¤ç”¨</h3>

<p><code class="highlighter-rouge">Handler#obtainMessage()</code>å†…éƒ¨è°ƒç”¨<code class="highlighter-rouge">Message#obtain()</code>æ–¹æ³•ï¼š</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre></td><td class="rouge-code"><pre>/**
 * Return a new Message instance from the global pool. Allows us to
 * avoid allocating new objects in many cases.
 */
public static Message obtain() {
    synchronized (sPoolSync) {
        if (sPool != null) {
            Message m = sPool;
            sPool = m.next;
            m.next = null;
            m.flags = 0; // clear in-use flag
            sPoolSize--;
            return m;
        }
    }
    return new Message();
}
</pre></td></tr></tbody></table></code></pre></div></div>

:ET